# Author: Aymeric Beaumet <hi@aymericbeaumet.com> (https://aymericbeaumet.com)
# Github: @aymericbeaumet/dotfiles

# Ensure Homebrew binaries are available in run-shell commands
set-environment -g PATH "/opt/homebrew/bin:/opt/homebrew/sbin:/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin"

# Reset all prefix bindings on reload
unbind-key -a -T prefix

# Prefix: C-q
set -g prefix C-q
bind C-q send-prefix

# Window management
unbind c
bind   t new-window -a -c "#{pane_current_path}"
bind C-t new-window -a -c "#{pane_current_path}"
bind   n next-window
bind C-n next-window
bind   p previous-window
bind C-p previous-window

# Splits
bind   v split-window -h -c "#{pane_current_path}"
bind C-v split-window -h -c "#{pane_current_path}"
bind   s split-window -v -c "#{pane_current_path}"
bind C-s split-window -v -c "#{pane_current_path}"

# Pane navigation (prefix + hjkl as backup, C-hjkl handled by vim-tmux-navigator)
bind      h if -F '#{pane_at_left}'   '' 'select-pane -L'
bind BSpace if -F '#{pane_at_left}'   '' 'select-pane -L'
bind      j if -F '#{pane_at_bottom}' '' 'select-pane -D'
bind    C-j if -F '#{pane_at_bottom}' '' 'select-pane -D'
bind      k if -F '#{pane_at_top}'    '' 'select-pane -U'
bind    C-k if -F '#{pane_at_top}'    '' 'select-pane -U'
bind      l if -F '#{pane_at_right}'  '' 'select-pane -R'
bind    C-l if -F '#{pane_at_right}'  '' 'select-pane -R'

# Pane swapping
bind H swap-pane -s '{left-of}'
bind J swap-pane -s '{down-of}'
bind K swap-pane -s '{up-of}'
bind L swap-pane -s '{right-of}'

# Search
bind / command-prompt -p "(search down)" "copy-mode; send -X search-forward  \"%%%\""
bind ? command-prompt -p "(search up)"   "copy-mode; send -X search-backward \"%%%\""

# Misc (x = kill pane; q conflicts with prefix C-q)
bind x kill-pane
bind r source "$HOME/.tmux.conf" \; display-message "Config reloaded"
bind [ copy-mode

# Copy mode (vi) - let tmux-yank handle y, keep squeeze on enter
set -g mode-keys vi
set -g escape-time 0
bind -T copy-mode-vi enter send -X copy-pipe-and-cancel "squeeze -1 --url --open"
bind -T copy-mode-vi escape send -X cancel
bind -T copy-mode-vi d send -X halfpage-down
bind -T copy-mode-vi u send -X halfpage-up
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi C-v send -X rectangle-toggle

# Status bindings
set -g status-keys emacs

# Performance & behavior
setw -g aggressive-resize on
set -g history-limit 50000
set -g focus-events on
set -g renumber-windows on
set -g display-time 3000
set -g repeat-time 600
set -g detach-on-destroy off
set -g set-clipboard on

# Quiet
set -g visual-activity off
set -g visual-bell off
set -g visual-silence off
set -gw monitor-activity off
set -g bell-action none

# Mouse
set -g mouse on

# True color support (same as original - don't change without full tmux restart)
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",*:RGB"
set -ga terminal-features "*:hyperlinks"

# Windows
set -g base-index 1
set -g allow-rename off
set -g automatic-rename off
set -g window-status-format                      " #(basename '#{b:pane_current_path}'):#{pane_current_command}"
set -g window-status-current-format " #[underscore]#(basename '#{b:pane_current_path}'):#{pane_current_command}"

# Panes
set -g pane-border-style fg=white
setw -g pane-base-index 1

# Status bar
set -g status 2
set -g status-interval 5
set -g status-position top
set -g status-style fg=white,bg=color232
set -g status-left "  "
set -g status-right "%a %d %b %R  "
set -g status-right-length 64
set -g status-format[1] ''

# Copy mode theme
set -g mode-style fg=colour255,bg=colour178
set-hook -g pane-mode-changed 'if -F "#{m/r:(copy|view)-mode,#{pane_mode}}" "set status-style fg=colour255,bg=colour178" "set -u status-style"'

# ─────────────────────────────────────────────────────────────
# QUICK ACCESS POPUPS (fzf/tool integration)
# ─────────────────────────────────────────────────────────────
bind g display-popup -E -w 90% -h 90% -d "#{pane_current_path}" "zsh -lc lazygit"
bind C-g display-popup -E -w 90% -h 90% -d "#{pane_current_path}" "zsh -lc lazygit"

# ─────────────────────────────────────────────────────────────
# PLUGINS
# ─────────────────────────────────────────────────────────────

# Required for headless TPM operations (install/update scripts)
set-environment -g TMUX_PLUGIN_MANAGER_PATH "$HOME/.tmux/plugins"

set -g @plugin 'tmux-plugins/tpm'

# Vimium-style hints for copy/open
# Usage: prefix + y triggers thumbs, then:
#   - type hint in lowercase → copy to clipboard
#   - type hint in UPPERCASE → copy + open
set -g @plugin 'fcsonline/tmux-thumbs'
set -g @thumbs-key y
set -g @thumbs-command 'echo -n {} | pbcopy'
set -g @thumbs-upcase-command 'echo -n {} | pbcopy && open {}'

# Enhanced copy mode - o to open, O to edit, S to search
set -g @plugin 'tmux-plugins/tmux-open'

# Better clipboard - handles y in copy mode, mouse selection, prefix+y
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @yank-selection 'clipboard'

# Kill frozen processes (prefix + C-c twice)
set -g @plugin 'tmux-plugins/tmux-cowboy'

# Initialize TPM (keep at bottom)
run '${TMUX_PLUGIN_MANAGER_PATH}/tpm/tpm'
